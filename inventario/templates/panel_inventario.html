{% extends 'base.html' %}

{% block titulo %}Panel Inventario{% endblock %}

{% block contenido %}

<div class="mb-4 p-3 bg-white rounded shadow-sm">
  <h3 class="mb-3">Información general del inventario</h3>
  <div class="row">
    <div class="col-md-4 mb-2"><strong>Inventario de la tienda:</strong> {{ inventario_info.0 }}</div>
    <div class="col-md-2 mb-2"><strong>Stock total:</strong> {{ inventario_info.1 }}</div>
    <div class="col-md-2 mb-2"><strong>Valor total:</strong> {{ inventario_info.2 }}</div>
    <div class="col-md-2 mb-2"><strong>Tipo productos:</strong> {{ inventario_info.3 }}</div>
    <div class="col-md-2 mb-2"><strong>Fecha cambio:</strong> {{ inventario_info.4 }}</div>
  </div>
</div>

<div class="table-responsive bg-white rounded shadow-sm p-3">
  <h4 class="mb-3 text-center">Productos del Inventario</h4>
  <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
          <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Valor unitario</th>
              <th>Valor stock</th>
              <th>Stock mínimo</th>
              <th>Stock máximo</th>
              {% if rol == "administrador" %}
              <th colspan="2">Acciones</th>
              {% endif %}
          </tr>
      </thead>
      <tbody>
          {% for producto in productos %}
          <tr>
              <td>{{ producto.1 }}</td>
              <td>{{ producto.2 }}</td>
              <td>${{ producto.3 }}</td>
              <td>${{ producto.4 }}</td>
              <td>{{ producto.5 }}</td>
              <td>{{ producto.6 }}</td>
              {% if rol == "administrador" %}
              <td>
                <button class="btn btn-sm btn-primary btn-actualizar" 
                        data-id="{{ producto.0 }}"
                        data-cantidad="{{ producto.2 }}"
                        data-stock_min="{{ producto.5 }}"
                        data-stock_max="{{ producto.6 }}">
                  <i class="bi bi-pencil-square"></i> Actualizar
                </button>
              </td>
              <td>
                <a href="{% url 'eliminar_producto_inventario' producto.0 %}" class="btn btn-sm btn-danger">
                  <i class="bi bi-trash"></i> Eliminar
                </a>
              </td>
              {% endif %}
          </tr>
          {% endfor %}
      </tbody>
  </table>
  <div class="mb-3 text-center">
    <a href="{% url 'ingreso_inventario' %}" class="btn btn-success me-2">
      Ingreso Inventario
    </a>
    <a href="#" class="btn btn-info text-white">
      Traslado Inventario
    </a>
  </div>
</div>

<div class="modal fade" id="modalActualizar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formActualizar" method="POST" action="">
        {% csrf_token %}
        <input type="hidden" name="id_detalle_inventario" id="modal-id">
        <div class="modal-header">
          <h5 class="modal-title">Actualizar Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" class="form-control" name="cantidad" id="modal-cantidad" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Mínimo</label>
            <input type="number" class="form-control" name="stock_minimo" id="modal-stock_min" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Máximo</label>
            <input type="number" class="form-control" name="stock_maximo" id="modal-stock_max" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const modalActualizar = new bootstrap.Modal(document.getElementById('modalActualizar'));

  const cantidadInput = document.getElementById('modal-cantidad');
  const stockMinInput = document.getElementById('modal-stock_min');
  const stockMaxInput = document.getElementById('modal-stock_max');

  stockMinInput.addEventListener('input', () => {
    cantidadInput.min = stockMinInput.value;
  });

  stockMaxInput.addEventListener('input', () => {
    cantidadInput.max = stockMaxInput.value;
  });

  document.querySelectorAll('.btn-actualizar').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('modal-id').value = btn.dataset.id;
      cantidadInput.value = btn.dataset.cantidad;
      stockMinInput.value = btn.dataset.stock_min;
      stockMaxInput.value = btn.dataset.stock_max;

      cantidadInput.min = stockMinInput.value;
      cantidadInput.max = stockMaxInput.value;

      document.getElementById('formActualizar').action = `/inicio/inventario/actualizar/${btn.dataset.id}`;

      modalActualizar.show();
    });
  });
});
</script>
{% endblock %}
